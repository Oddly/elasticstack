---
# Back up a certificate file or directory before renewal.
# Copies to a timestamped backup, then removes the original.
#
# Required variables:
#   _backup_path:   Path to file or directory to back up
#   _backup_target: Target host for the backup (inventory_hostname, elasticstack_ca_host, or "localhost")
#
# Optional variables:
#   _backup_become:  Whether to use become (default: true unless localhost)

- name: "Check if {{ _backup_path }} exists on {{ _backup_target }}"
  ansible.builtin.stat:
    path: "{{ _backup_path }}"
  register: _backup_stat
  delegate_to: "{{ _backup_target if _backup_target != inventory_hostname else omit }}"
  become: "{{ _backup_become | default(_backup_target != 'localhost') }}"

- name: "Back up {{ _backup_path }} on {{ _backup_target }}"
  ansible.builtin.copy:
    src: "{{ _backup_path }}"
    dest: "{{ _backup_path }}_{{ ansible_date_time.iso8601_micro }}"
    mode: preserve
    remote_src: "{{ _backup_target != 'localhost' }}"
  when: _backup_stat.stat.exists
  delegate_to: "{{ _backup_target if _backup_target != inventory_hostname else omit }}"
  become: "{{ _backup_become | default(_backup_target != 'localhost') }}"
  register: _backup_result

- name: "Remove original {{ _backup_path }} on {{ _backup_target }}"
  ansible.builtin.file:
    path: "{{ _backup_path }}"
    state: absent
  when: _backup_result.changed | default(false)
  delegate_to: "{{ _backup_target if _backup_target != inventory_hostname else omit }}"
  become: "{{ _backup_become | default(_backup_target != 'localhost') }}"
