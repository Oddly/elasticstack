---
# Fetch a user password from the Elasticsearch initial passwords file.
# Delegates to elasticstack_ca_host.
#
# Required variables:
#   _password_user: Username to grep for (e.g. "elastic", "kibana_system")
#   _password_fact: Fact name to set (e.g. "elasticstack_password")
#
# The result is a shell register dict â€” use {{ fact_name.stdout }} downstream.

- name: "Fetch {{ _password_user }} password"
  ansible.builtin.shell: >
    set -o pipefail;
    grep "PASSWORD {{ _password_user }} " {{ elasticstack_initial_passwords }} |
    awk '{print $4}'
  args:
    executable: /bin/bash
  register: _fetched_password_result
  changed_when: false
  no_log: "{{ elasticstack_no_log }}"
  delegate_to: "{{ elasticstack_ca_host }}"

- name: "Register {{ _password_fact }}"
  ansible.builtin.set_fact:
    "{{ _password_fact }}": "{{ _fetched_password_result }}"
  no_log: "{{ elasticstack_no_log }}"
