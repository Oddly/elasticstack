---
- name: Determine certificate management mode
  ansible.builtin.set_fact:
    _logstash_cert_mode: "{{ logstash_cert_source | default('elasticsearch_ca') }}"

- name: Handle external certificates
  when: _logstash_cert_mode == 'external'
  block:
    - name: Validate external certificate paths are provided
      ansible.builtin.assert:
        that:
          - logstash_tls_certificate_file is defined
          - logstash_tls_key_file is defined
        fail_msg: "External cert mode requires logstash_tls_certificate_file and logstash_tls_key_file"

    - name: Create certificate directory
      ansible.builtin.file:
        state: directory
        path: "{{ logstash_certs_dir }}"
        owner: root
        group: logstash
        mode: "0750"

    - name: Copy external certificate
      ansible.builtin.copy:
        src: "{{ logstash_tls_certificate_file }}"
        dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-server.crt"
        owner: root
        group: logstash
        mode: "0640"
      notify:
        - Restart Logstash

    - name: Copy external key
      ansible.builtin.copy:
        src: "{{ logstash_tls_key_file }}"
        dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key"
        owner: root
        group: logstash
        mode: "0640"
      notify:
        - Restart Logstash

    - name: Copy external CA certificate
      ansible.builtin.copy:
        src: "{{ logstash_tls_ca_file }}"
        dest: "{{ logstash_certs_dir }}/ca.crt"
        owner: root
        group: logstash
        mode: "0640"
      when: logstash_tls_ca_file is defined
      notify:
        - Restart Logstash

- name: Handle Elasticsearch CA certificates
  when: _logstash_cert_mode == 'elasticsearch_ca'
  block:
    - name: Check if logstash certificate exists
      ansible.builtin.stat:
        path: "{{ logstash_certs_dir }}/{{ ansible_hostname }}-ls.p12"
      register: _logstash_cert_exists

    - name: Get certificate expiration date
      cert_info:
        path: "{{ logstash_certs_dir }}/{{ ansible_hostname }}-ls.p12"
        passphrase: "{{ logstash_tls_key_passphrase | default(omit, true) }}"
      register: _logstash_cert_expiration
      when: _logstash_cert_exists.stat.exists | bool

    - name: Calculate days until expiration
      ansible.builtin.set_fact:
        _logstash_cert_expiration_days: >-
          {{ (((_logstash_cert_expiration.not_valid_after | regex_replace('[+-]\d{2}:\d{2}$', ''))
          | to_datetime('%Y-%m-%d %H:%M:%S')) - (ansible_date_time.date | to_datetime('%Y-%m-%d'))).days }}
      when:
        - _logstash_cert_exists.stat.exists | bool
        - _logstash_cert_expiration.skipped is not defined

    - name: Determine if certificate renewal is needed
      ansible.builtin.set_fact:
        _logstash_needs_cert_renewal: >-
          {{ (not _logstash_cert_exists.stat.exists) or
             (logstash_cert_force_regenerate | default(false) | bool) or
             (_logstash_cert_expiration_days is defined and
              _logstash_cert_expiration_days | int <= logstash_cert_expiration_buffer | int) }}

    - name: Display certificate renewal message
      ansible.builtin.debug:
        msg: >-
          Certificate will expire in {{ _logstash_cert_expiration_days }} days.
          Renewal threshold is {{ logstash_cert_expiration_buffer }} days.
          Initiating automatic renewal.
      when:
        - _logstash_cert_expiration_days is defined
        - _logstash_cert_expiration_days | int <= logstash_cert_expiration_buffer | int

    - name: Backup and remove existing certificates for renewal
      when: _logstash_needs_cert_renewal | bool and _logstash_cert_exists.stat.exists
      block:
        - name: Backup certificate directory on Logstash host
          ansible.builtin.copy:
            src: "{{ logstash_certs_dir }}"
            dest: "{{ logstash_certs_dir }}_backup_{{ ansible_date_time.iso8601_basic_short }}"
            mode: preserve
            remote_src: true

        - name: Remove old certificate directory
          ansible.builtin.file:
            path: "{{ logstash_certs_dir }}"
            state: absent

        - name: Remove old certificate on CA host
          ansible.builtin.file:
            path: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12"
            state: absent
          delegate_to: "{{ elasticstack_ca_host }}"

        - name: Remove old PEM certificate zip on CA host
          ansible.builtin.file:
            path: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip"
            state: absent
          delegate_to: "{{ elasticstack_ca_host }}"

    - name: Generate and distribute certificates
      when: _logstash_needs_cert_renewal | bool
      block:
        - name: Create certificate directory
          ansible.builtin.file:
            state: directory
            path: "{{ logstash_certs_dir }}"
            owner: root
            group: logstash
            mode: "0750"
          tags:
            - certificates

        - name: Generate P12 certificate on CA host
          ansible.builtin.command: >
            /usr/share/elasticsearch/bin/elasticsearch-certutil cert
            --days {{ logstash_cert_validity_period }}
            --ca {{ elasticstack_ca_dir }}/elastic-stack-ca.p12
            --ca-pass {{ elasticstack_ca_pass }}
            --name {{ ansible_hostname }}
            --ip {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}
            --dns {{ ansible_hostname }},{{ ansible_fqdn }},{{ inventory_hostname }}
            --pass {{ logstash_tls_key_passphrase }}
            --out {{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12
          delegate_to: "{{ elasticstack_ca_host }}"
          no_log: "{{ elasticstack_no_log }}"
          args:
            creates: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12"
          tags:
            - certificates

        - name: Fetch P12 certificate to controller
          ansible.builtin.fetch:
            src: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12"
            dest: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.p12"
            flat: true
          delegate_to: "{{ elasticstack_ca_host }}"
          tags:
            - certificates

        - name: Copy P12 certificate to Logstash host
          ansible.builtin.copy:
            src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.p12"
            dest: "{{ logstash_certs_dir }}/{{ ansible_hostname }}-ls.p12"
            owner: root
            group: logstash
            mode: "0640"
          tags:
            - certificates

        - name: Copy P12 as keystore
          ansible.builtin.copy:
            src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.p12"
            dest: "{{ logstash_certs_dir }}/keystore.pfx"
            owner: root
            group: logstash
            mode: "0640"
          notify:
            - Restart Logstash
          tags:
            - certificates

        - name: Generate PEM certificate on CA host
          ansible.builtin.command: >
            /usr/share/elasticsearch/bin/elasticsearch-certutil cert
            --days {{ logstash_cert_validity_period }}
            --ca {{ elasticstack_ca_dir }}/elastic-stack-ca.p12
            --ca-pass {{ elasticstack_ca_pass }}
            --name {{ ansible_hostname }}
            --ip {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}
            --dns {{ ansible_hostname }},{{ ansible_fqdn }},{{ inventory_hostname }}
            --pass {{ logstash_tls_key_passphrase }}
            --pem
            --out {{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip
          delegate_to: "{{ elasticstack_ca_host }}"
          no_log: "{{ elasticstack_no_log }}"
          args:
            creates: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip"
          tags:
            - certificates

        - name: Fetch PEM certificate zip to controller
          ansible.builtin.fetch:
            src: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip"
            dest: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.zip"
            flat: true
          delegate_to: "{{ elasticstack_ca_host }}"
          tags:
            - certificates

        - name: Extract PEM certificate on Logstash host
          ansible.builtin.unarchive:
            src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.zip"
            dest: "{{ logstash_certs_dir }}/"
            owner: root
            group: logstash
            mode: "0640"
          tags:
            - certificates

        - name: Copy server certificate to standard location
          ansible.builtin.copy:
            src: "{{ logstash_certs_dir }}/{{ ansible_hostname }}/{{ ansible_hostname }}.crt"
            dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-server.crt"
            owner: root
            group: logstash
            mode: "0640"
            remote_src: true
          tags:
            - certificates

        - name: Copy encrypted key
          ansible.builtin.copy:
            src: "{{ logstash_certs_dir }}/{{ ansible_hostname }}/{{ ansible_hostname }}.key"
            dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}.key"
            owner: root
            group: root
            mode: "0640"
            remote_src: true
          tags:
            - certificates

        - name: Create unencrypted PKCS8 key for Logstash
          ansible.builtin.command: >
            openssl pkcs8
            -in {{ logstash_certs_dir }}/{{ inventory_hostname }}.key
            -topk8
            -passin pass:{{ logstash_tls_key_passphrase }}
            -out {{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key
            -nocrypt
          args:
            creates: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key"
          no_log: "{{ elasticstack_no_log }}"
          tags:
            - certificates

        - name: Set permissions on PKCS8 key
          ansible.builtin.file:
            path: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key"
            owner: root
            group: logstash
            mode: "0660"
          tags:
            - certificates

        - name: Fetch CA certificate to controller
          ansible.builtin.fetch:
            src: "{{ elasticstack_ca_dir }}/ca.crt"
            dest: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/ca.crt"
            flat: true
          delegate_to: "{{ elasticstack_ca_host }}"
          tags:
            - certificates

        - name: Copy CA certificate to Logstash host
          ansible.builtin.copy:
            src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/ca.crt"
            dest: "{{ logstash_certs_dir }}/ca.crt"
            owner: root
            group: logstash
            mode: "0640"
          notify:
            - Restart Logstash
          tags:
            - certificates

- name: Manage Elasticsearch user and role
  when: _logstash_cert_mode in ['elasticsearch_ca', 'standalone']
  block:
    - name: Validate logstash user password length
      ansible.builtin.fail:
        msg: "Logstash user password must be at least 6 characters long"
      when: logstash_user_password | length < 6

    - name: Fetch Elastic admin password
      ansible.builtin.shell: >
        set -o pipefail;
        grep "PASSWORD elastic" {{ elasticstack_initial_passwords }} | awk '{print $4}'
      args:
        executable: /bin/bash
      register: _logstash_elastic_password
      changed_when: false
      delegate_to: "{{ elasticstack_ca_host }}"
      no_log: "{{ elasticstack_no_log }}"

    - name: Create logstash role
      oddly.elasticstack.elasticsearch_role:
        name: "{{ logstash_role_name }}"
        cluster: "{{ logstash_role_cluster_privileges }}"
        indicies:
          - names: "{{ logstash_role_indicies_names }}"
            privileges: "{{ logstash_role_indicies_privileges }}"
        state: present
        host: "https://{{ hostvars[elasticstack_ca_host].ansible_default_ipv4.address }}:{{ elasticstack_elasticsearch_http_port }}"
        auth_user: elastic
        auth_pass: "{{ _logstash_elastic_password.stdout }}"
        verify_certs: true
        ca_certs: "{{ logstash_certs_dir }}/ca.crt"
      when: logstash_create_role | bool

    - name: Create logstash user
      oddly.elasticstack.elasticsearch_user:
        name: "{{ logstash_user_name }}"
        fullname: "{{ logstash_user_fullname }}"
        password: "{{ logstash_user_password }}"
        email: "{{ logstash_user_email }}"
        roles:
          - "{{ logstash_role_name }}"
        enabled: true
        state: present
        host: "https://{{ hostvars[elasticstack_ca_host].ansible_default_ipv4.address }}:{{ elasticstack_elasticsearch_http_port }}"
        auth_user: elastic
        auth_pass: "{{ _logstash_elastic_password.stdout }}"
        verify_certs: true
        ca_certs: "{{ logstash_certs_dir }}/ca.crt"
      when: logstash_create_user | bool
