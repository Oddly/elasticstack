---
- name: Determine certificate management mode
  ansible.builtin.set_fact:
    _logstash_cert_mode: "{{ logstash_cert_source | default('elasticsearch_ca') }}"

- name: Handle external certificates
  when: _logstash_cert_mode == 'external'
  block:
    - name: Validate external certificate paths are provided
      ansible.builtin.assert:
        that:
          - logstash_tls_certificate_file is defined
          - logstash_tls_key_file is defined
        fail_msg: "External cert mode requires logstash_tls_certificate_file and logstash_tls_key_file"

    - name: Create certificate directory
      ansible.builtin.file:
        state: directory
        path: "{{ logstash_certs_dir }}"
        owner: root
        group: logstash
        mode: "0750"

    - name: Copy external certificate
      ansible.builtin.copy:
        src: "{{ logstash_tls_certificate_file }}"
        dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-server.crt"
        owner: root
        group: logstash
        mode: "0640"
        remote_src: "{{ logstash_tls_remote_src | default(false) }}"
      notify:
        - Restart Logstash

    - name: Copy external key
      ansible.builtin.copy:
        src: "{{ logstash_tls_key_file }}"
        dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key"
        owner: root
        group: logstash
        mode: "0640"
        remote_src: "{{ logstash_tls_remote_src | default(false) }}"
      notify:
        - Restart Logstash

    - name: Copy external CA certificate
      ansible.builtin.copy:
        src: "{{ logstash_tls_ca_file }}"
        dest: "{{ logstash_certs_dir }}/ca.crt"
        owner: root
        group: logstash
        mode: "0640"
        remote_src: "{{ logstash_tls_remote_src | default(false) }}"
      when: logstash_tls_ca_file is defined
      notify:
        - Restart Logstash

- name: Handle Elasticsearch CA certificates
  when: _logstash_cert_mode == 'elasticsearch_ca'
  block:
    # -- Check Logstash certificate expiry --
    - name: Check Logstash certificate expiry
      ansible.builtin.include_tasks:
        file: "{{ role_path }}/../elasticstack/tasks/certs/cert_check_expiry.yml"
        apply:
          tags:
            - certificates
      vars:
        _cert_path: "{{ logstash_certs_dir }}/{{ ansible_hostname }}-ls.p12"
        _cert_pass: "{{ logstash_tls_key_passphrase }}"
        _cert_buffer_days: "{{ logstash_cert_expiration_buffer }}"
        _cert_expiry_fact: logstash_cert_will_expire_soon
      tags:
        - certificates

    # -- Determine if renewal is needed (Logstash-specific combined logic) --
    - name: Determine if certificate renewal is needed
      ansible.builtin.set_fact:
        _logstash_needs_cert_renewal: >-
          {{ (not (_cert_stat.stat.exists | default(false))) or
             (logstash_cert_force_regenerate | default(false) | bool) or
             (logstash_cert_will_expire_soon | default(false) | bool) }}

    # -- Backup and remove existing certificates --
    - name: Backup Logstash cert directory
      ansible.builtin.include_tasks:
        file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
      vars:
        _backup_path: "{{ logstash_certs_dir }}"
        _backup_target: "{{ inventory_hostname }}"
      when:
        - _logstash_needs_cert_renewal | bool
        - _cert_stat.stat.exists | default(false)

    - name: Remove old certificate on CA host
      ansible.builtin.file:
        path: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12"
        state: absent
      delegate_to: "{{ elasticstack_ca_host }}"
      when:
        - _logstash_needs_cert_renewal | bool
        - _cert_stat.stat.exists | default(false)

    - name: Remove old PEM certificate zip on CA host
      ansible.builtin.file:
        path: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip"
        state: absent
      delegate_to: "{{ elasticstack_ca_host }}"
      when:
        - _logstash_needs_cert_renewal | bool
        - _cert_stat.stat.exists | default(false)

    # -- Generate and distribute certificates --
    - name: Generate and distribute certificates
      when: _logstash_needs_cert_renewal | bool
      block:
        - name: Create certificate directory
          ansible.builtin.file:
            state: directory
            path: "{{ logstash_certs_dir }}"
            owner: root
            group: logstash
            mode: "0750"
          tags:
            - certificates

        # -- P12 certificate --
        - name: Generate P12 certificate for Logstash
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../elasticstack/tasks/certs/cert_generate.yml"
            apply:
              tags:
                - certificates
          vars:
            _cert_name: "{{ ansible_hostname }}"
            _cert_ip: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
            _cert_dns: "{{ ansible_hostname }},{{ ansible_fqdn }},{{ inventory_hostname }}"
            _cert_out: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12"
            _cert_pass: "{{ logstash_tls_key_passphrase }}"
            _cert_validity: "{{ logstash_cert_validity_period }}"
          tags:
            - certificates

        - name: Distribute P12 certificate to Logstash host
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
            apply:
              tags:
                - certificates
          vars:
            _cert_src: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.p12"
            _cert_dest: "{{ logstash_certs_dir }}/{{ ansible_hostname }}-ls.p12"
            _cert_owner: root
            _cert_group: logstash
            _cert_mode: "0640"
          tags:
            - certificates

        - name: Copy P12 as keystore
          ansible.builtin.copy:
            src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.p12"
            dest: "{{ logstash_certs_dir }}/keystore.pfx"
            owner: root
            group: logstash
            mode: "0640"
          notify:
            - Restart Logstash
          tags:
            - certificates

        # -- PEM certificate (kept inline, zip+PKCS8 flow is Logstash-specific) --
        - name: Generate PEM certificate for Logstash
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../elasticstack/tasks/certs/cert_generate.yml"
            apply:
              tags:
                - certificates
          vars:
            _cert_name: "{{ ansible_hostname }}"
            _cert_ip: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
            _cert_dns: "{{ ansible_hostname }},{{ ansible_fqdn }},{{ inventory_hostname }}"
            _cert_out: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip"
            _cert_pass: "{{ logstash_tls_key_passphrase }}"
            _cert_validity: "{{ logstash_cert_validity_period }}"
            _cert_format: pem
          tags:
            - certificates

        - name: Fetch PEM certificate zip to controller
          ansible.builtin.fetch:
            src: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-ls.zip"
            dest: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.zip"
            flat: true
          delegate_to: "{{ elasticstack_ca_host }}"
          tags:
            - certificates

        - name: Extract PEM certificate on Logstash host
          ansible.builtin.unarchive:
            src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-ls.zip"
            dest: "{{ logstash_certs_dir }}/"
            owner: root
            group: logstash
            mode: "0640"
          tags:
            - certificates

        - name: Copy server certificate to standard location
          ansible.builtin.copy:
            src: "{{ logstash_certs_dir }}/{{ ansible_hostname }}/{{ ansible_hostname }}.crt"
            dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-server.crt"
            owner: root
            group: logstash
            mode: "0640"
            remote_src: true
          tags:
            - certificates

        - name: Copy encrypted key
          ansible.builtin.copy:
            src: "{{ logstash_certs_dir }}/{{ ansible_hostname }}/{{ ansible_hostname }}.key"
            dest: "{{ logstash_certs_dir }}/{{ inventory_hostname }}.key"
            owner: root
            group: root
            mode: "0640"
            remote_src: true
          tags:
            - certificates

        - name: Create unencrypted PKCS8 key for Logstash
          ansible.builtin.command: >
            openssl pkcs8
            -in {{ logstash_certs_dir }}/{{ inventory_hostname }}.key
            -topk8
            -passin pass:{{ logstash_tls_key_passphrase }}
            -out {{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key
            -nocrypt
          args:
            creates: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key"
          no_log: "{{ elasticstack_no_log }}"
          tags:
            - certificates

        - name: Set permissions on PKCS8 key
          ansible.builtin.file:
            path: "{{ logstash_certs_dir }}/{{ inventory_hostname }}-pkcs8.key"
            owner: root
            group: logstash
            mode: "0640"
          tags:
            - certificates

        # -- CA certificate distribution --
        - name: Distribute CA certificate to Logstash host
          ansible.builtin.include_tasks:
            file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
            apply:
              tags:
                - certificates
          vars:
            _cert_src: "{{ elasticstack_ca_dir }}/ca.crt"
            _cert_dest: "{{ logstash_certs_dir }}/ca.crt"
            _cert_owner: root
            _cert_group: logstash
            _cert_mode: "0640"
            _cert_notify:
              - Restart Logstash
          tags:
            - certificates

- name: Manage Elasticsearch user and role
  when: _logstash_cert_mode in ['elasticsearch_ca', 'standalone']
  block:
    - name: Validate logstash user password length
      ansible.builtin.fail:
        msg: "Logstash user password must be at least 6 characters long"
      when: logstash_user_password | length < 6

    - name: Fetch Elastic admin password
      ansible.builtin.include_tasks:
        file: "{{ role_path }}/../elasticstack/tasks/fetch_password.yml"
      vars:
        _password_user: elastic
        _password_fact: _logstash_elastic_password

    - name: Create logstash role
      oddly.elasticstack.elasticsearch_role:
        name: "{{ logstash_role_name }}"
        cluster: "{{ logstash_role_cluster_privileges }}"
        indicies:
          - names: "{{ logstash_role_indicies_names }}"
            privileges: "{{ logstash_role_indicies_privileges }}"
        state: present
        host: "https://{{ hostvars[elasticstack_ca_host].ansible_default_ipv4.address }}:{{ elasticstack_elasticsearch_http_port }}"
        auth_user: elastic
        auth_pass: "{{ _logstash_elastic_password.stdout }}"
        verify_certs: true
        ca_certs: "{{ logstash_certs_dir }}/ca.crt"
      when: logstash_create_role | bool

    - name: Create logstash user
      oddly.elasticstack.elasticsearch_user:
        name: "{{ logstash_user_name }}"
        fullname: "{{ logstash_user_fullname }}"
        password: "{{ logstash_user_password }}"
        email: "{{ logstash_user_email }}"
        roles:
          - "{{ logstash_role_name }}"
        enabled: true
        state: present
        host: "https://{{ hostvars[elasticstack_ca_host].ansible_default_ipv4.address }}:{{ elasticstack_elasticsearch_http_port }}"
        auth_user: elastic
        auth_pass: "{{ _logstash_elastic_password.stdout }}"
        verify_certs: true
        ca_certs: "{{ logstash_certs_dir }}/ca.crt"
      when: logstash_create_user | bool
