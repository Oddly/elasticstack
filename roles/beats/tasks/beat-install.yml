---
# Install a beat package. Handles versioned and latest installs across
# RPM (full-stack and standalone) and Debian.
#
# Required variables:
#   _beat_name: Beat name (e.g. "filebeat", "auditbeat", "metricbeat")

- name: "Construct exact package name for {{ _beat_name }}"
  ansible.builtin.set_fact:
    beats_package: >-
      {{
      _beat_name +
      ((elasticstack_versionseparator +
      elasticstack_version |
      string ) if (elasticstack_version is defined and elasticstack_version | length > 0)) |
      replace(' ', '') }}

- name: "Install rpm full-stack package for {{ _beat_name }}"
  ansible.builtin.package:
    name: "{{ beats_package }}"
    enablerepo:
      - 'elastic-{{ elasticstack_release }}.x'
  notify: "Restart {{ _beat_name | capitalize }}"
  when:
    - ansible_facts.os_family == "RedHat"
    - elasticstack_full_stack | bool

- name: "Install rpm standalone package for {{ _beat_name }}"
  ansible.builtin.package:
    name: "{{ beats_package }}"
  notify: "Restart {{ _beat_name | capitalize }}"
  when:
    - ansible_facts.os_family == "RedHat"
    - not elasticstack_full_stack | bool

- name: "Install deb package for {{ _beat_name }}"
  ansible.builtin.package:
    name: "{{ beats_package }}"
  notify: "Restart {{ _beat_name | capitalize }}"
  when:
    - ansible_facts.os_family == "Debian"

- name: "Install latest rpm full-stack package for {{ _beat_name }}"
  ansible.builtin.package:
    name: "{{ _beat_name }}"
    state: latest
    enablerepo:
      - "elastic-{{ elasticstack_release }}.x"
  notify: "Restart {{ _beat_name | capitalize }}"
  when:
    - elasticstack_version is defined
    - elasticstack_version == "latest"
    - ansible_facts.os_family == "RedHat"
    - elasticstack_full_stack | bool

- name: "Install latest rpm standalone package for {{ _beat_name }}"
  ansible.builtin.package:
    name: "{{ _beat_name }}"
    state: latest
  notify: "Restart {{ _beat_name | capitalize }}"
  when:
    - elasticstack_version is defined
    - elasticstack_version == "latest"
    - ansible_facts.os_family == "RedHat"
    - not elasticstack_full_stack | bool

- name: "Install latest deb package for {{ _beat_name }}"
  ansible.builtin.package:
    name: "{{ _beat_name }}"
    state: latest
  notify: "Restart {{ _beat_name | capitalize }}"
  when:
    - elasticstack_version is defined
    - elasticstack_version == "latest"
    - ansible_facts.os_family == "Debian"
