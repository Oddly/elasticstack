---

# -- Check Beats certificate expiry (PEM format) --
- name: Check Beats certificate expiry
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_check_expiry.yml"
    apply:
      tags:
        - certificates
        - renew_beats_cert
  vars:
    _cert_path: "/etc/beats/certs/{{ inventory_hostname }}-beats.crt"
    _cert_format: pem
    _cert_buffer_days: "{{ beats_cert_expiration_buffer }}"
    _cert_expiry_fact: beats_cert_will_expire_soon
  tags:
    - certificates
    - renew_beats_cert

# -- Backup Beats certs on node --
- name: Backup Beats certs on node
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_beats_cert
  vars:
    _backup_path: /etc/beats/certs
    _backup_target: "{{ inventory_hostname }}"
  when: "'renew_beats_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or beats_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_beats_cert

# -- Backup Beats cert on CA host --
- name: Backup Beats cert on CA host
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_beats_cert
  vars:
    _backup_path: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-beats.zip"
    _backup_target: "{{ elasticstack_ca_host }}"
  when: "'renew_beats_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or beats_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_beats_cert

# -- Backup Beats cert on Ansible controller --
- name: Backup Beats cert on Ansible controller
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_beats_cert
  vars:
    _backup_path: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-beats.zip"
    _backup_target: localhost
    _backup_become: false
  when: "'renew_beats_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or beats_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_beats_cert

# -- Create Beats certificate directory (Beats-specific path/perms) --
- name: Create certificate directory
  ansible.builtin.file:
    path: /etc/beats/certs
    state: directory
    owner: root
    group: root
    mode: "0700"
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

# -- Generate PEM certificate for Beats --
- name: Generate Beats certificate
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_generate.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_beats_cert
  vars:
    _cert_name: "{{ ansible_hostname }}"
    _cert_ip: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
    _cert_dns: "{{ ansible_hostname }},{{ ansible_fqdn }},{{ inventory_hostname }}"
    _cert_out: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-beats.zip"
    _cert_pass: "{{ beats_tls_key_passphrase }}"
    _cert_validity: "{{ beats_cert_validity_period }}"
    _cert_format: pem
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

# -- Distribute PEM cert (zip) to Beats node (kept inline, zip requires unarchive) --
- name: Fetch certificate zip from CA host to controller
  ansible.builtin.fetch:
    src: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-beats.zip"
    dest: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-beats.zip"
    flat: true
  delegate_to: "{{ elasticstack_ca_host }}"
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

- name: Extract certificate on Beats node
  ansible.builtin.unarchive:
    src: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-beats.zip"
    dest: "/etc/beats/certs/"
    owner: root
    group: root
    mode: "0640"
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

- name: Copy certificate to standard location
  ansible.builtin.copy:
    src: "/etc/beats/certs/{{ ansible_hostname }}/{{ ansible_hostname }}.crt"
    dest: "/etc/beats/certs/{{ inventory_hostname }}-beats.crt"
    owner: root
    group: root
    mode: "0640"
    remote_src: true
  notify:
    - Restart Filebeat
    - Restart Auditbeat
    - Restart Metricbeat
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

- name: Copy key to standard location
  ansible.builtin.copy:
    src: "/etc/beats/certs/{{ ansible_hostname }}/{{ ansible_hostname }}.key"
    dest: "/etc/beats/certs/{{ inventory_hostname }}-beats.key"
    owner: root
    group: root
    mode: "0640"
    remote_src: true
  notify:
    - Restart Filebeat
    - Restart Auditbeat
    - Restart Metricbeat
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

# -- Distribute CA certificate to Beats nodes --
- name: Distribute CA certificate to Beats nodes
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_beats_cert
  vars:
    _cert_src: "{{ elasticstack_ca_dir }}/ca.crt"
    _cert_dest: /etc/beats/certs/ca.crt
    _cert_owner: root
    _cert_group: root
    _cert_mode: "0640"
    _cert_notify:
      - Restart Filebeat
      - Restart Auditbeat
      - Restart Metricbeat
  tags:
    - certificates
    - renew_ca
    - renew_beats_cert

# -- Fetch Beats password --
- name: Fetch Beats password
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/fetch_password.yml"
  vars:
    _password_user: elastic
    _password_fact: beats_writer_password
