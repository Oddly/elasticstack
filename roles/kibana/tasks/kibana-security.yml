---

# -- Check Kibana certificate expiry --
- name: Check Kibana certificate expiry
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_check_expiry.yml"
    apply:
      tags:
        - certificates
        - renew_kibana_cert
  vars:
    _cert_path: "/etc/kibana/certs/{{ ansible_hostname }}-kibana.p12"
    _cert_pass: "{{ kibana_tls_key_passphrase }}"
    _cert_buffer_days: "{{ kibana_cert_expiration_buffer }}"
    _cert_expiry_fact: kibana_cert_will_expire_soon
  tags:
    - certificates
    - renew_kibana_cert

# -- Backup Kibana certs on node --
- name: Backup Kibana certs on node
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_kibana_cert
  vars:
    _backup_path: /etc/kibana/certs
    _backup_target: "{{ inventory_hostname }}"
  when: "'renew_kibana_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or kibana_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_kibana_cert

# -- Backup Kibana cert on CA host --
- name: Backup Kibana cert on CA host
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_kibana_cert
  vars:
    _backup_path: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-kibana.p12"
    _backup_target: "{{ elasticstack_ca_host }}"
  when: "'renew_kibana_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or kibana_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_kibana_cert

# -- Backup Kibana cert on Ansible controller --
- name: Backup Kibana cert on Ansible controller
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_kibana_cert
  vars:
    _backup_path: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_hostname }}-kibana.p12"
    _backup_target: localhost
    _backup_become: false
  when: "'renew_kibana_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or kibana_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_kibana_cert

# -- Encryption keys (Kibana-specific, kept inline) --
- name: Block for key generation
  delegate_to: "{{ elasticstack_ca_host }}"
  run_once: true
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert
  block:
    - name: Generate encryption key # noqa: risky-shell-pipe
      ansible.builtin.shell: >
        if test -n "$(ps -p $$ | grep bash)"; then set -o pipefail; fi;
        openssl rand -base64 36 >
        {{ elasticstack_ca_dir }}/encryption_key
      changed_when: false
      args:
        creates: "{{ elasticstack_ca_dir }}/encryption_key"

    - name: Fetch encryption key
      ansible.builtin.command: cat {{ elasticstack_ca_dir }}/encryption_key
      changed_when: false
      register: kibana_encryption_key

    - name: Generate saved objects encryption key # noqa: risky-shell-pipe
      ansible.builtin.shell: >
        if test -n "$(ps -p $$ | grep bash)"; then set -o pipefail; fi;
        openssl rand
        -base64 36 >
        {{ elasticstack_ca_dir }}/savedobjects_encryption_key
      changed_when: false
      args:
        creates: "{{ elasticstack_ca_dir }}/savedobjects_encryption_key"

    - name: Fetch saved objects encryption key
      ansible.builtin.command: cat {{ elasticstack_ca_dir }}/savedobjects_encryption_key
      changed_when: false
      register: kibana_savedobjects_encryption_key

# -- Create Kibana certificate directory (Kibana-specific path/perms) --
- name: Create certificate directory
  ansible.builtin.file:
    path: /etc/kibana/certs
    state: directory
    owner: root
    group: kibana
    mode: 0750
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert

# -- Generate Kibana certificate --
- name: Generate Kibana certificate
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_generate.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_kibana_cert
  vars:
    _cert_name: "{{ ansible_hostname }}"
    _cert_ip: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
    _cert_dns: "{{ ansible_hostname }},{{ ansible_fqdn }},{{ inventory_hostname }}"
    _cert_out: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-kibana.p12"
    _cert_pass: "{{ kibana_tls_key_passphrase }}"
    _cert_validity: "{{ kibana_cert_validity_period }}"
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert

# -- Distribute Kibana certificate --
- name: Distribute Kibana certificate
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_kibana_cert
  vars:
    _cert_src: "{{ elasticstack_ca_dir }}/{{ ansible_hostname }}-kibana.p12"
    _cert_dest: "/etc/kibana/certs/{{ ansible_hostname }}-kibana.p12"
    _cert_owner: root
    _cert_group: kibana
    _cert_mode: "0640"
    _cert_notify:
      - Restart Kibana
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert

# -- Fetch Kibana password (not cert logic, kept inline) --
- name: Fetch Kibana password # noqa: risky-shell-pipe
  ansible.builtin.shell: >
    if test -n "$(ps -p $$ | grep bash)"; then set -o pipefail; fi;
    grep "PASSWORD kibana_system " /usr/share/elasticsearch/initial_passwords |
    awk {' print $4 '}
  register: kibana_password
  changed_when: false
  no_log: "{{ elasticstack_no_log }}"
  delegate_to: "{{ elasticstack_ca_host }}"

# -- Distribute CA certificate to Kibana nodes --
- name: Distribute CA certificate to Kibana nodes
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_kibana_cert
  vars:
    _cert_src: "{{ elasticstack_ca_dir }}/ca.crt"
    _cert_dest: /etc/kibana/certs/ca.crt
    _cert_owner: root
    _cert_group: kibana
    _cert_mode: "0640"
    _cert_notify:
      - Restart Kibana
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert
