---

# -- Check Kibana certificate expiry --
- name: Check Kibana certificate expiry
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_check_expiry.yml"
    apply:
      tags:
        - certificates
        - renew_kibana_cert
  vars:
    _cert_path: "/etc/kibana/certs/{{ ansible_facts.hostname }}-kibana.p12"
    _cert_pass: "{{ kibana_tls_key_passphrase }}"
    _cert_buffer_days: "{{ kibana_cert_expiration_buffer }}"
    _cert_expiry_fact: kibana_cert_will_expire_soon
  tags:
    - certificates
    - renew_kibana_cert

# -- Backup Kibana certs on node --
- name: Backup Kibana certs on node
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_kibana_cert
  vars:
    _backup_path: /etc/kibana/certs
    _backup_target: "{{ inventory_hostname }}"
  when: "'renew_kibana_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or kibana_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_kibana_cert

# -- Backup Kibana cert on CA host --
- name: Backup Kibana cert on CA host
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_kibana_cert
  vars:
    _backup_path: "{{ elasticstack_ca_dir }}/{{ ansible_facts.hostname }}-kibana.p12"
    _backup_target: "{{ elasticstack_ca_host }}"
  when: "'renew_kibana_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or kibana_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_kibana_cert

# -- Backup Kibana cert on Ansible controller --
- name: Backup Kibana cert on Ansible controller
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_backup.yml"
    apply:
      tags:
        - renew_ca
        - renew_kibana_cert
  vars:
    _backup_path: "{{ lookup('config', 'DEFAULT_LOCAL_TMP') | dirname }}/{{ ansible_facts.hostname }}-kibana.p12"
    _backup_target: localhost
    _backup_become: false
  when: "'renew_kibana_cert' in ansible_run_tags or 'renew_ca' in ansible_run_tags or kibana_cert_will_expire_soon | bool"
  tags:
    - renew_ca
    - renew_kibana_cert

# -- Encryption keys (Kibana-specific, kept inline) --
- name: Block for key generation
  delegate_to: "{{ elasticstack_ca_host }}"
  run_once: true
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert
  block:
    - name: Generate encryption key
      ansible.builtin.shell: >
        set -o pipefail;
        openssl rand -base64 36 >
        {{ elasticstack_ca_dir }}/encryption_key
      args:
        executable: /bin/bash
        creates: "{{ elasticstack_ca_dir }}/encryption_key"
      changed_when: false

    - name: Fetch encryption key
      ansible.builtin.slurp:
        src: "{{ elasticstack_ca_dir }}/encryption_key"
      register: kibana_encryption_key

    - name: Generate saved objects encryption key
      ansible.builtin.shell: >
        set -o pipefail;
        openssl rand -base64 36 >
        {{ elasticstack_ca_dir }}/savedobjects_encryption_key
      args:
        executable: /bin/bash
        creates: "{{ elasticstack_ca_dir }}/savedobjects_encryption_key"
      changed_when: false

    - name: Fetch saved objects encryption key
      ansible.builtin.slurp:
        src: "{{ elasticstack_ca_dir }}/savedobjects_encryption_key"
      register: kibana_savedobjects_encryption_key

# -- Create Kibana certificate directory (Kibana-specific path/perms) --
- name: Create certificate directory
  ansible.builtin.file:
    path: /etc/kibana/certs
    state: directory
    owner: root
    group: kibana
    mode: "0750"
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert

# -- Generate Kibana certificate --
- name: Generate Kibana certificate
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_generate.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_kibana_cert
  vars:
    _cert_name: "{{ ansible_facts.hostname }}"
    _cert_ip: "{{ ansible_facts.default_ipv4.address | default(ansible_facts.all_ipv4_addresses[0]) }}"
    _cert_dns: "{{ ansible_facts.hostname }},{{ ansible_facts.fqdn }},{{ inventory_hostname }}"
    _cert_out: "{{ elasticstack_ca_dir }}/{{ ansible_facts.hostname }}-kibana.p12"
    _cert_pass: "{{ kibana_tls_key_passphrase }}"
    _cert_validity: "{{ kibana_cert_validity_period }}"
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert

# -- Distribute Kibana certificate --
- name: Distribute Kibana certificate
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_kibana_cert
  vars:
    _cert_src: "{{ elasticstack_ca_dir }}/{{ ansible_facts.hostname }}-kibana.p12"
    _cert_dest: "/etc/kibana/certs/{{ ansible_facts.hostname }}-kibana.p12"
    _cert_owner: root
    _cert_group: kibana
    _cert_mode: "0640"
    _cert_notify:
      - Restart Kibana
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert

# -- Fetch Kibana password --
- name: Fetch Kibana password
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/fetch_password.yml"
  vars:
    _password_user: kibana_system
    _password_fact: kibana_password

# -- Distribute CA certificate to Kibana nodes --
- name: Distribute CA certificate to Kibana nodes
  ansible.builtin.include_tasks:
    file: "{{ role_path }}/../elasticstack/tasks/certs/cert_distribute.yml"
    apply:
      tags:
        - certificates
        - renew_ca
        - renew_kibana_cert
  vars:
    _cert_src: "{{ elasticstack_ca_dir }}/ca.crt"
    _cert_dest: /etc/kibana/certs/ca.crt
    _cert_owner: root
    _cert_group: kibana
    _cert_mode: "0640"
    _cert_notify:
      - Restart Kibana
  tags:
    - certificates
    - renew_ca
    - renew_kibana_cert
