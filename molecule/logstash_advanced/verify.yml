---
- name: Verify advanced Logstash configuration
  hosts: all
  tasks:
    - name: Check Logstash service is running
      ansible.builtin.service:
        name: logstash
        state: started
      check_mode: true
      register: logstash_service
      failed_when: logstash_service.changed

    # --- Pipeline structure ---

    - name: Check input configuration exists
      ansible.builtin.stat:
        path: /etc/logstash/conf.d/main/10-input.conf
      register: input_conf
      failed_when: not input_conf.stat.exists

    - name: Check filter configuration exists
      ansible.builtin.stat:
        path: /etc/logstash/conf.d/main/50-filter.conf
      register: filter_conf
      failed_when: not filter_conf.stat.exists

    - name: Check output configuration exists
      ansible.builtin.stat:
        path: /etc/logstash/conf.d/main/90-output.conf
      register: output_conf
      failed_when: not output_conf.stat.exists

    # --- Extra input verification ---

    - name: Read input configuration
      ansible.builtin.slurp:
        src: /etc/logstash/conf.d/main/10-input.conf
      register: input_content

    - name: Verify beats and http inputs are configured
      ansible.builtin.assert:
        that:
          - "'beats {' in (input_content.content | b64decode)"
          - "'http {' in (input_content.content | b64decode)"
          - "'port => 8080' in (input_content.content | b64decode)"
        fail_msg: "Expected beats and http inputs not found"

    # --- Filter file verification ---

    - name: Check custom filter file was copied
      ansible.builtin.stat:
        path: /etc/logstash/conf.d/main/20-custom-filter.conf
      register: custom_filter

    - name: Assert custom filter file exists
      ansible.builtin.assert:
        that:
          - custom_filter.stat.exists
        fail_msg: "Custom filter file was not copied to conf.d/main/"

    - name: Read custom filter file
      ansible.builtin.slurp:
        src: /etc/logstash/conf.d/main/20-custom-filter.conf
      register: custom_filter_content

    - name: Verify custom filter content
      ansible.builtin.assert:
        that:
          - "'custom_filter_applied' in (custom_filter_content.content | b64decode)"
        fail_msg: "Custom filter file content incorrect"

    # --- Inline filter + ident verification ---

    - name: Read filter configuration
      ansible.builtin.slurp:
        src: /etc/logstash/conf.d/main/50-filter.conf
      register: filter_content

    - name: Verify grok filter is present
      ansible.builtin.assert:
        that:
          - "'grok {' in (filter_content.content | b64decode)"
          - "'SYSLOGLINE' in (filter_content.content | b64decode)"
        fail_msg: "Grok filter not found"

    - name: Verify ident mutate filter is present
      ansible.builtin.assert:
        that:
          - "'mutate' in (filter_content.content | b64decode)"
          - "'instance' in (filter_content.content | b64decode)"
        fail_msg: "Ident filter not found in 50-filter.conf"

    - name: Verify pipeline identifier is present
      ansible.builtin.assert:
        that:
          - "'pipeline' in (filter_content.content | b64decode)"
        fail_msg: "Pipeline identifier not found in 50-filter.conf"

    # --- Output verification ---

    - name: Read output configuration
      ansible.builtin.slurp:
        src: /etc/logstash/conf.d/main/90-output.conf
      register: output_content

    - name: Verify file output is configured
      ansible.builtin.assert:
        that:
          - "'file {' in (output_content.content | b64decode)"
          - "'advanced-output.log' in (output_content.content | b64decode)"
        fail_msg: "File output not properly configured"

    # --- Logstash.yml verification ---

    - name: Read logstash.yml
      ansible.builtin.slurp:
        src: /etc/logstash/logstash.yml
      register: logstash_yml

    - name: Verify queue type is persisted
      ansible.builtin.assert:
        that:
          - "'queue.type: persisted' in (logstash_yml.content | b64decode)"
        fail_msg: "Queue type not set to persisted"

    - name: Verify queue max bytes
      ansible.builtin.assert:
        that:
          - "'queue.max_bytes: 512mb' in (logstash_yml.content | b64decode)"
        fail_msg: "Queue max bytes not set to 512mb"

    - name: Verify autoreload is enabled
      ansible.builtin.assert:
        that:
          - "'config.reload.automatic: true' in (logstash_yml.content | b64decode)"
        fail_msg: "Config autoreload not enabled"

    # --- Config backup verification ---

    - name: Check for logstash.yml backup files
      ansible.builtin.find:
        paths: /etc/logstash
        patterns: "logstash.yml.*"
      register: yml_backups

    - name: Report backup status
      ansible.builtin.debug:
        msg: "Found {{ yml_backups.files | length }} logstash.yml backup(s)"

    # --- Logging configuration verification ---

    - name: Check log4j2.properties exists (managed logging)
      ansible.builtin.stat:
        path: /etc/logstash/log4j2.properties
      register: log4j2

    - name: Assert log4j2.properties is present
      ansible.builtin.assert:
        that:
          - log4j2.stat.exists
        fail_msg: "log4j2.properties not found (logstash_manage_logging=true)"

    # --- Plugin verification ---

    - name: Check translate plugin is installed
      ansible.builtin.command: /usr/share/logstash/bin/logstash-plugin list logstash-filter-translate
      register: plugin_list
      changed_when: false
      failed_when: "'logstash-filter-translate' not in plugin_list.stdout"

    # --- Port check ---

    - name: Check Logstash is listening on port 5044
      ansible.builtin.wait_for:
        port: 5044
        timeout: 120
        state: started
      register: port_check
      ignore_errors: true

    - name: Show diagnostics on port check failure
      when: port_check is failed
      block:
        - name: Show Logstash log after failure
          ansible.builtin.shell: >-
            journalctl -u logstash --no-pager -n 100 2>/dev/null ||
            tail -100 /var/log/logstash/logstash-plain.log 2>/dev/null ||
            echo "No logs found"
          register: logstash_log
          changed_when: false

        - name: Display failure log  # noqa: no-handler
          ansible.builtin.debug:
            var: logstash_log.stdout_lines

        - name: Fail with context
          ansible.builtin.fail:
            msg: "Logstash port 5044 did not open within timeout."

    # --- Config syntax validation ---

    - name: Get installed Logstash version
      ansible.builtin.shell: >-
        (v=$(dpkg-query -W -f='${Version}' logstash 2>/dev/null) &&
        echo "${v}" | sed 's/^[0-9]*://;s/-.*$//') ||
        rpm -q --qf '%{VERSION}' logstash 2>/dev/null
      register: logstash_version
      changed_when: false

    - name: Verify Logstash config syntax
      ansible.builtin.command: >-
        /usr/share/logstash/bin/logstash
        --path.settings=/etc/logstash
        --config.test_and_exit
        -f /etc/logstash/conf.d/main/
      become: "{{ logstash_version.stdout is version('9.0.0', '>=', version_type='loose') }}"
      become_method: su
      become_user: "{{ 'logstash' if logstash_version.stdout is version('9.0.0', '>=', version_type='loose') else omit }}"
      become_flags: '-s /bin/sh'
      register: config_test
      changed_when: false
      failed_when: config_test.rc != 0
